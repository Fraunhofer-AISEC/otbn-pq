# OTBN-PQ: Enabling Lattice-Based Post-Quantum Cryptography on the OpenTitan Platform


This code has been published as part of the following conference paper: [Enabling Lattice-Based Post-Quantum Cryptography on the OpenTitan Platform](https://dl.acm.org/doi/10.1145/3605769.3623993)


This version of the OTBN with PQ-Extension works with the [Earlgrey-M2.5.2-RC0 Release](https://github.com/lowRISC/opentitan/releases/tag/Earlgrey-M2.5.2-RC0) (Commit **21ce4e9**) of the OpenTitan.

To checkout this commit/tag use the following command:
```console
git checkout 21ce4e9
```
## Synthesize OTBN-PQ Standalone

With the following commands a build script for standalone test synthesis for the OTBN-PQ for Vivado is generated:
```console
fusesoc --cores-root . run --flag=fileset_top --target=synth --no-export --setup aisec:ip:otbn_pq:0.1
cd build/aisec_ip_otbn_pq_0.1/synth-vivado/
. /tools/Xilinx/Vivado/2020.2/settings64.sh
vivado
```

Within Vivado execute the following commands to generate the project:
```console
source aisec_ip_otbn_pq_0.1.tcl
```

### Results
Test synthesis results (Vivado 2020.2 - 21.06.2023)

|                          | LUTs          | FFs           | BRAMs         | DSPs          | 
| -------------------------|:-------------:|:-------------:|:-------------:|:-------------:|
| **OTBN-PQ**              | **55,409**    | **16,575**    | **14.5**      | **49**        |
| PQ-ALU                   | 1,830         | 0             | 0             | 11            |
| Twiddle Update Unit      | 1,939         | 904           | 0             | 22            |
| Register Address Unit    | 118           | 47            | 0             | 0             |
| Keccak Lane Unit         | 992           | 0             | 0             | 0             |
| Keccak Plane Unit        | 320           | 0             | 0             | 0             |

## Simulate OTBN-PQ Standalone

With the following commands a build script for standalone RTL-simulation environnemnt for the OTBN-PQ for Vivado is generated:
```console
fusesoc --cores-root . run --flag=fileset_top --target=sim --no-export --setup aisec:ip:otbn_pq:0.1
cd build/aisec_ip_otbn_pq_0.1/sim-vivado/
. /tools/Xilinx/Vivado/2020.2/settings64.sh
vivado
```

Within Vivado execute the following commands to generate the project and configure the simulator:

```console
source aisec_ip_otbn_pq_0.1.tcl
set_property top tb_otbn [get_filesets sim_1]
set_property top_lib xil_defaultlib [get_filesets sim_1]
set_property -name {xsim.simulate.runtime} -value {5000000ns} -objects [get_filesets sim_1]
```

To generate the IMEM and DMEM contents for the RTL-testbench, execute the following bash script:

```console
cd hw/vendor/aisec_otbn_pq
dv/sv/gen_mem_files.sh
```

Within *dv/sv/tb_otbn.sv* the paths to the tests and the log file have to be set accordingly:

```console
localparam string                 log_path = "/home/user/projects/aisec/opentitan/hw/vendor/aisec_otbn_pq/dv/sv/log/";
localparam string                 mem_path = "/home/user/projects/aisec/opentitan/hw/vendor/aisec_otbn_pq/dv/sv/";
```

When running the simulation, the memory files generated by the *dv/sv/gen_mem_files.sh* script are loaded into DMEM and IMEM. 
These memory files correspond to the applications within the *sw/* directory. For debugging the applications *dv/sv/log* logs all bus accesses. Furthermore, the clock cycles necessary to execute an application are counted (see Results). 

### Troubleshooting
Running the simulation might not function out of the box when using Vivado simulator. This is due to two files which might have to be modified:

 - tlul_rsp_intg_chk:

```console
  logic [63:0] test1;
  logic [63:0] test2;  
  assign test1 = {tl_i.d_user.rsp_intg, D2HRspMaxWidth'(rsp)};
  assign test2 = {tl_i.d_user.data_intg, DataMaxWidth'(tl_i.d_data)};

  prim_secded_inv_64_57_dec u_chk (
    .data_i(test1),
    .data_o(),
    .syndrome_o(),
    .err_o(rsp_err)
  );

  logic rsp_data_err;
  if (EnableRspDataIntgCheck) begin : gen_rsp_data_intg_check
    tlul_data_integ_dec u_tlul_data_integ_dec (
      .data_intg_i(test2),
      .data_err_o(rsp_data_err)
    );
```
 - tlul_cmd_intg_chk:

```console
    logic[63:0] test1;
    assign test1 = {tl_i.a_user.data_intg, DataMaxWidth'(tl_i.a_data)};
    logic[63:0] test2;
    assign test2 = {tl_i.a_user.cmd_intg, H2DCmdMaxWidth'(cmd)};

    prim_secded_inv_64_57_dec u_chk (
      .data_i(test2),
      .data_o(),
      .syndrome_o(),
      .err_o(err)
    );

    tlul_data_integ_dec u_tlul_data_integ_dec (
      .data_intg_i(test1),
      .data_err_o(data_err)
    );

```
### Results
Simulation results (Vivado 2020.2 - 21.06.2023)

| Test                     | CC            | Errors  |
| -------------------------|:-------------:| -----:|
| Keccak                   | 1,204         | 0 |
| Kyber-NTT                | 1,642         | 0 |
| Kyber-INTT               | 1,904         | 0 |
| Kyber-BaseMul            | 1,626         | 0 |
| Dilithium-NTT            | 2,160         | 0 |
| Dilithium-INTT           | 2,422         | 0 |
| Dilithium-Mul            | 956           | 0 |
| Dilithium-II Verify      | 403,592       | 0 |
| Dilithium-III Verify     | 683,674       | 0 |
| Dilithium-V Verify       | 1,194,032     | 0 |
These results include the CCs for the secure wipe at the end of an application.

## Citation

Cite this work, please use the following BibTeX entry:

```
@inproceedings{10.1145/3605769.3623993,
author = {Stelzer, Tobias and Oberhansl, Felix and Schupp, Jonas and Karl, Patrick},
title = {Enabling Lattice-Based Post-Quantum Cryptography on the OpenTitan Platform},
year = {2023},
isbn = {9798400702624},
publisher = {Association for Computing Machinery},
address = {New York, NY, USA},
url = {https://doi.org/10.1145/3605769.3623993},
doi = {10.1145/3605769.3623993},
booktitle = {Proceedings of the 2023 Workshop on Attacks and Solutions in Hardware Security},
pages = {51â€“60},
numpages = {10},
keywords = {post-quantum cryptography, digital signatures, hardware/software co-design, lattice-based cryptography},
location = {<conf-loc>, <city>Copenhagen</city>, <country>Denmark</country>, </conf-loc>},
series = {ASHES '23}
}
```
## License

[Apache License Version 2.0](LICENSE)

This repository includes code from the following third party libraries:

[OpenTitan](https://github.com/lowRISC/opentitan): [Apache License 2.0](https://github.com/lowRISC/opentitan/blob/master/LICENSE)